<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Nh·∫Øn g·ª≠i l·ªùi y√™u th∆∞∆°ng</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Theme Colors - Ultra Modern Premium Admin */
            --primary: #4F46E5;
            --primary-hover: #4338CA;
            --secondary: #0F172A;
            --bg-base: #F8FAFC;
            --bg-panel: #FFFFFF;

            --text-main: #1E293B;
            --text-muted: #64748B;
            --border-solid: #E2E8F0;
            --border-light: #F1F5F9;

            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-base);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            overflow: hidden;
            /* Prevent body scroll, use internal scroll */
            width: 100vw;
            height: 100vh;
        }

        .container {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        h1,
        h2,
        h3,
        h4 {
            color: var(--secondary);
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 24px;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #CBD5E1;
            border-radius: 10px;
            border: 2px solid var(--bg-panel);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94A3B8;
        }

        /* ===== DASHBOARD LAYOUT ===== */
        #dashboard-section {
            display: none;
        }

        #dashboard-section[style*="block"] {
            display: grid !important;
            grid-template-columns: 260px 1fr;
            grid-template-rows: 72px 1fr;
            grid-template-areas:
                "sidebar header"
                "sidebar main";
            height: 100vh;
            width: 100vw;
            background: var(--bg-base);
        }

        /* Responsive Dashboard */
        @media (max-width: 1024px) {
            #dashboard-section[style*="block"] {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
                grid-template-areas:
                    "header"
                    "sidebar"
                    "main";
            }

            body {
                overflow-y: auto;
            }

            #dashboard-section[style*="block"] {
                height: auto;
                min-height: 100vh;
            }
        }

        .header-bar {
            grid-area: header;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-panel);
            padding: 0 40px;
            border-bottom: 1px solid var(--border-solid);
            z-index: 10;
        }

        .header-bar h1 {
            margin: 0;
            font-size: 22px;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .admin-email {
            font-weight: 700;
            color: var(--text-main);
            font-size: 14px;
            background: var(--bg-base);
            padding: 8px 16px;
            border-radius: 30px;
            border: 1px solid var(--border-solid);
        }

        /* ===== MENU NAVIGATION ===== */
        .admin-menu {
            grid-area: sidebar;
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 32px 20px;
            margin: 0;
            background: var(--bg-panel);
            border-right: 1px solid var(--border-solid);
            overflow-y: auto;
            z-index: 20;
        }

        .admin-menu::before {
            content: "WORKSPACE";
            display: block;
            font-size: 11px;
            font-weight: 900;
            color: var(--text-muted);
            letter-spacing: 0.1em;
            margin-bottom: 20px;
            margin-left: 12px;
        }

        @media (max-width: 1024px) {
            .admin-menu {
                flex-direction: row;
                padding: 16px;
                border-right: none;
                border-bottom: 1px solid var(--border-solid);
            }

            .admin-menu::before {
                display: none;
            }
        }

        .menu-item {
            padding: 14px 20px;
            text-align: left;
            background: transparent;
            color: var(--text-muted);
            border: none;
            cursor: pointer;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 15px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .menu-item:hover {
            color: var(--primary);
            background: var(--bg-base);
            transform: translateX(4px);
        }

        @media (max-width: 1024px) {
            .menu-item:hover {
                transform: translateY(-2px);
            }
        }

        .menu-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            font-weight: 700;
        }

        /* ===== SECTION VISIBILITY ===== */
        .admin-section {
            display: none;
            grid-area: main;
            padding: 40px;
            overflow-y: auto;
            /* Internal scrolling for main content */
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .admin-section.active {
            display: block;
        }

        /* ===== LOGIN FORM ===== */
        #login-section {
            max-width: 440px;
            margin: 120px auto;
            background: var(--bg-panel);
            padding: 50px 40px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-solid);
        }

        #login-section h2 {
            text-align: center;
            color: var(--secondary);
            font-size: 28px;
            margin-bottom: 12px;
        }

        /* ===== FORMS & INPUTS ===== */
        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 14px;
            color: var(--secondary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-solid);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: inherit;
            background: var(--bg-base);
            color: var(--text-main);
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            background: #ffffff;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
            width: auto;
            border-radius: 8px;
        }

        /* ===== STATS CARDS ===== */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-panel);
            padding: 32px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-solid);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--border-solid);
        }

        .stat-number {
            font-size: 44px;
            font-weight: 900;
            color: var(--secondary);
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* ===== SEARCH ===== */
        .search-box {
            width: 100%;
            padding: 16px 24px;
            border: 1px solid var(--border-solid);
            border-radius: var(--radius-lg);
            font-size: 15px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-sm);
            background: #ffffff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%2394a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>') no-repeat right 20px center;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        /* ===== CORE LIST CONTAINERS ===== */
        .messages-section {
            background: var(--bg-panel);
            padding: 32px 40px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: 40px;
            border: 1px solid var(--border-solid);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-light);
        }

        .section-title {
            font-size: 20px;
            font-weight: 800;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message-count {
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 800;
        }

        /* Item styles */
        .message-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* MESSAGES ITEMS */
        .message-item {
            background: var(--bg-base);
            padding: 24px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-solid);
            transition: all 0.2s ease;
        }

        .message-item:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .message-text {
            font-size: 15px;
            color: var(--text-main);
            margin-bottom: 20px;
            line-height: 1.7;
            background: #ffffff;
            padding: 20px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-light);
            max-height: 200px;
            overflow-y: auto;
        }

        .sender-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .sender-name {
            font-weight: 700;
            color: var(--secondary);
            font-size: 16px;
        }

        .anonymous-badge {
            background: #E2E8F0;
            color: var(--text-muted);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .message-meta {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 20px;
            font-weight: 600;
        }

        .message-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* GALLERY & BANNER ITEMS */
        .gallery-item,
        .banner-item,
        .member-item,
        .program-item {
            display: flex;
            gap: 24px;
            align-items: flex-start;
            background: var(--bg-base);
            padding: 24px;
            margin-bottom: 16px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-solid);
            transition: all 0.2s ease;
            width: 100%;
        }

        @media (max-width: 600px) {

            .gallery-item,
            .banner-item,
            .member-item,
            .program-item {
                flex-direction: column;
            }
        }

        .gallery-item:hover,
        .banner-item:hover,
        .member-item:hover,
        .program-item:hover {
            box-shadow: var(--shadow-sm);
            transform: translateY(-2px);
            border-color: var(--border-solid);
        }

        /* IMAGES (Critical Fix for Overflow) */
        .gallery-item img,
        .banner-item img,
        .member-item img,
        .program-item img {
            width: 280px;
            height: 160px;
            min-width: 280px;
            object-fit: contain;
            /* CRUCIAL FLAG FOR BANNER */
            background: #e2e8f0;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-light);
        }

        @media (max-width: 600px) {

            .gallery-item img,
            .banner-item img,
            .member-item img,
            .program-item img {
                width: 100%;
                min-width: 100%;
                height: auto;
            }
        }

        /* Specific fix for member images if they are vertical portraits */
        .member-item img.p-avatar {
            width: 140px;
            height: 140px;
            min-width: 140px;
            object-fit: cover;
            border-radius: 50%;
        }

        .info {
            flex: 1;
            min-width: 0;
            word-wrap: break-word;
            /* prevent long links from breaking container */
        }

        .info h4 {
            margin: 0 0 8px;
            font-size: 18px;
            font-weight: 800;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .info p {
            margin: 0 0 10px;
            color: var(--text-muted);
            font-size: 14px;
            line-height: 1.5;
            word-break: break-word;
        }

        .info .order {
            display: inline-block;
            margin: 0;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-main);
            background: #E2E8F0;
            padding: 4px 12px;
            border-radius: 20px;
        }

        /* EDIT LIKES */
        .edit-like-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #fff;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-solid);
        }

        .edit-like-input {
            width: 70px;
            padding: 8px;
            border: 1px solid var(--border-solid);
            border-radius: 6px;
            text-align: center;
            font-weight: 700;
            font-size: 14px;
        }

        .edit-like-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .current-likes {
            font-weight: 800;
            color: #ec4899;
            min-width: 40px;
        }

        /* MULTI FORMS */
        #gallery-form,
        #program-form,
        #banner-form,
        #member-form,
        #tag-form {
            background: var(--bg-base);
            padding: 32px;
            margin-bottom: 32px;
            border-radius: var(--radius-md);
            border: 1px dashed #cbd5e1;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        /* NOTIFICATIONS */
        .notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            border-radius: var(--radius-sm);
            color: white;
            font-weight: 700;
            font-size: 15px;
            z-index: 9999;
            transform: translateY(150px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-lg);
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--danger);
        }

        .empty,
        .loading {
            text-align: center;
            padding: 60px 40px;
            color: var(--text-muted);
            font-size: 16px;
            font-weight: 600;
            background: var(--bg-base);
            border-radius: var(--radius-md);
            border: 1px dashed var(--border-solid);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 24px;
            padding: 16px;
            background: #fff;
            border: 1px solid var(--border-solid);
            border-radius: var(--radius-sm);
        }

        .checkbox-group input {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            font-weight: 600;
            color: var(--text-main);
        }

        .tag-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 20px;
            border: 1px solid var(--border-solid);
            border-radius: var(--radius-lg);
            background: #fff;
        }

        .tag-check {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border-solid);
            background: var(--bg-base);
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }

        .tag-check input {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .tag-check:hover {
            background: #fff;
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
            border-color: var(--primary);
        }

        .tag-check .tag-text {
            font-weight: 700;
            font-size: 13px;
            color: var(--text-main);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--border-solid);
        }

        th {
            padding: 16px 20px;
            background: var(--bg-base);
            color: var(--secondary);
            font-size: 14px;
            text-align: left;
            font-weight: 800;
            border-bottom: 2px solid var(--border-solid);
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            font-size: 14px;
        }

        tr:hover td {
            background: var(--bg-base);
        }
    </style>



</head>

<body>
    <div class="container">
        <!-- üîê LOGIN SECTION -->
        <div id="login-section">
            <h2>üîê Admin Dashboard</h2>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">Qu·∫£n l√Ω l·ªùi nh·∫Øn, gallery, banner & th√†nh
                vi√™n</p>
            <div class="form-group"><label>Email</label><input type="email" id="admin-email"
                    placeholder="admin@loiythuong.com"></div>
            <div class="form-group"><label>M·∫≠t kh·∫©u</label><input type="password" id="admin-password"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
            <button class="btn btn-primary" onclick="handleLogin()">ƒêƒÉng nh·∫≠p</button>
            <p style="text-align: center; margin-top: 20px; font-size: 13px; color: #999;">Email:
                admin@loiythuong.com<br>M·∫≠t kh·∫©u: LoiYeuThuong123!</p>
        </div>

        <!-- üìä DASHBOARD SECTION -->
        <div id="dashboard-section">
            <div class="header-bar">
                <h1>üìä Admin Dashboard</h1>
                <div class="admin-info">
                    <span class="admin-email" id="admin-email-display"></span>
                    <button class="btn btn-danger btn-small" onclick="handleLogout()">ƒêƒÉng xu·∫•t</button>
                </div>
            </div>

            <!-- Th√™m menu ƒëi·ªÅu h∆∞·ªõng -->
            <div class="admin-menu">
                <button class="menu-item active" data-target="banner-section">üé® Banner</button>
                <button class="menu-item" data-target="gallery-section">üñºÔ∏è Gallery</button>
                <button class="menu-item" data-target="programs-section">üè• Ch∆∞∆°ng tr√¨nh</button>
                <button class="menu-item" data-target="members-section">üë• Th√†nh vi√™n</button>
                <button class="menu-item" data-target="tags-section">üè∑Ô∏è Tags</button>
                <button class="menu-item" data-target="stats-section">üìä Stats Bar</button>
                <button class="menu-item" data-target="journey-section">üìñ H√†nh tr√¨nh</button>
                <button class="menu-item" data-target="newsletter-section">üìß Newsletter</button>
                <button class="menu-item" data-target="messages-section">‚úâÔ∏è Messages</button>
            </div>

            <!-- C√°c section ƒë∆∞·ª£c s·∫Øp x·∫øp theo th·ª© t·ª± Banner -> Gallery -> Messages -->
            <!-- üé® BANNER SECTION -->
            <div id="banner-section" class="admin-section active">
                <!-- üìà STATS -->
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-number" id="stat-total">0</div>
                        <div class="stat-label">T·ªïng l·ªùi nh·∫Øn</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-pending" style="color: #ff9800;">0</div>
                        <div class="stat-label">Ch·ªù duy·ªát</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-approved" style="color: #4CAF50;">0</div>
                        <div class="stat-label">ƒê√£ duy·ªát</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-total-likes" style="color: #e91e63;">0</div>
                        <div class="stat-label">T·ªïng l∆∞·ª£t tim</div>
                    </div>
                </div>

                <!-- üé® BANNER MANAGEMENT (NEW) -->
                <div class="messages-section">
                    <div class="section-header">
                        <span class="section-title">üé® Qu·∫£n l√Ω Banner</span>
                        <button class="btn btn-success btn-small" onclick="showAddBannerForm()">+ Th√™m banner</button>
                    </div>

                    <!-- Add/Edit Form -->
                    <div id="banner-form">
                        <h3 id="banner-form-title">Th√™m banner m·ªõi</h3>
                        <div class="form-group"><label>Link ·∫£nh/URL *</label><input type="text" id="banner-image"
                                placeholder="https://example.com/banner.jpg  "></div>
                        <div class="form-group"><label>Ti√™u ƒë·ªÅ (optional)</label><input type="text" id="banner-title"
                                placeholder="Ti√™u ƒë·ªÅ banner"></div>
                        <div class="form-group"><label>Link khi click (optional)</label><input type="text"
                                id="banner-link" placeholder="https://example.com  "></div>
                        <div class="form-group"><label>Th·ª© t·ª± hi·ªÉn th·ªã</label><input type="number" id="banner-order"
                                value="1" min="1"></div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="banner-active" checked>
                            <label for="banner-active">Hi·ªÉn th·ªã banner</label>
                        </div>
                        <input type="hidden" id="banner-id">
                        <button class="btn btn-primary" onclick="saveBanner()">üíæ L∆∞u</button>
                        <button class="btn btn-warning" onclick="hideBannerForm()">‚ùå H·ªßy</button>
                    </div>

                    <!-- Banner List -->
                    <div class="message-list" id="banner-list">
                        <div class="loading">ƒêang t·∫£i banners...</div>
                    </div>
                </div>
            </div>

            <!-- üñºÔ∏è GALLERY SECTION -->
            <div id="gallery-section" class="admin-section">
                <!-- üîç SEARCH -->
                <input type="text" class="search-box" id="search-box" placeholder="üîç T√¨m ki·∫øm l·ªùi nh·∫Øn..."
                    oninput="filterMessages()">

                <!-- üî• GALLERY MANAGEMENT -->
                <div class="messages-section">
                    <div class="section-header">
                        <span class="section-title">üñºÔ∏è Qu·∫£n l√Ω Gallery</span>
                        <button class="btn btn-success btn-small" onclick="showAddGalleryForm()">+ Th√™m ·∫£nh</button>
                    </div>

                    <!-- Add/Edit Form -->
                    <div id="gallery-form">
                        <h3 id="gallery-form-title">Th√™m ·∫£nh m·ªõi</h3>
                        <div class="form-group"><label>Link ·∫£nh/URL</label><input type="text" id="gallery-image"
                                placeholder="gallery/activity-1.jpg ho·∫∑c https://..."></div>
                        <div class="form-group"><label>Ti√™u ƒë·ªÅ</label><input type="text" id="gallery-title"
                                placeholder="T√™n ho·∫°t ƒë·ªông"></div>
                        <div class="form-group"><label>M√¥ t·∫£ ng·∫Øn</label><textarea id="gallery-description" rows="3"
                                placeholder="M√¥ t·∫£ ng·∫Øn hi·ªÉn th·ªã b√™n ngo√†i ·∫£nh"></textarea></div>
                        <div class="form-group"><label>N·ªôi dung b√†i vi·∫øt (Nh·∫≠t k√Ω d√†i)</label><textarea
                                id="gallery-content" rows="10"
                                placeholder="H·ªó tr·ª£ vƒÉn b·∫£n v√† xu·ªëng d√≤ng. Th·∫≠m ch√≠ d√πng HTML c∆° b·∫£n..."></textarea>
                        </div>
                        <div class="form-group"><label>Link ·∫£nh th√™m (M·ªói link 1 d√≤ng)</label><textarea
                                id="gallery-extra-images" rows="4" placeholder="https://...\nhttps://..."></textarea>
                        </div>
                        <div class="form-group"><label>Th·ª© t·ª± hi·ªÉn th·ªã</label><input type="number" id="gallery-order"
                                value="1" min="1"></div>
                        <input type="hidden" id="gallery-id">
                        <button class="btn btn-primary" onclick="saveGallery()">üíæ L∆∞u</button>
                        <button class="btn btn-warning" onclick="hideGalleryForm()">‚ùå H·ªßy</button>
                    </div>

                    <!-- Gallery List -->
                    <div class="message-list" id="gallery-list">
                        <div class="loading">ƒêang t·∫£i gallery...</div>
                    </div>
                </div>
            </div>

            <!-- üè• PROGRAMS SECTION -->
            <div id="programs-section" class="admin-section">
                <!-- üî• PROGRAMS MANAGEMENT -->
                <div class="messages-section">
                    <div class="section-header">
                        <span class="section-title">üè• Qu·∫£n l√Ω Ch∆∞∆°ng tr√¨nh</span>
                        <button class="btn btn-success btn-small" onclick="showAddProgramForm()">+ Th√™m ch∆∞∆°ng
                            tr√¨nh</button>
                    </div>

                    <!-- Add/Edit Form -->
                    <div id="program-form">
                        <h3 id="program-form-title">Th√™m ch∆∞∆°ng tr√¨nh m·ªõi</h3>
                        <div class="form-group"><label>Link ·∫£nh/URL *</label><input type="text" id="program-image"
                                placeholder="https://..."></div>
                        <div class="form-group"><label>Ti√™u ƒë·ªÅ *</label><input type="text" id="program-title"
                                placeholder="T√™n ch∆∞∆°ng tr√¨nh"></div>
                        <div class="form-group"><label>M√¥ t·∫£ ng·∫Øn</label><textarea id="program-description" rows="3"
                                placeholder="M√¥ t·∫£ ng·∫Øn c·ªßa ch∆∞∆°ng tr√¨nh"></textarea></div>
                        <div class="form-group"><label>Chi ti·∫øt ch∆∞∆°ng tr√¨nh</label><textarea id="program-content"
                                rows="6" placeholder="Vi·∫øt chi ti·∫øt h∆°n v·ªÅ ch∆∞∆°ng tr√¨nh ·ªü ƒë√¢y..."></textarea></div>
                        <div class="form-group"><label>Th·ª© t·ª± hi·ªÉn th·ªã</label><input type="number" id="program-order"
                                value="1" min="1"></div>
                        <input type="hidden" id="program-id">
                        <button class="btn btn-primary" onclick="saveProgram()">üíæ L∆∞u</button>
                        <button class="btn btn-warning" onclick="hideProgramForm()">‚ùå H·ªßy</button>
                    </div>

                    <!-- Program List -->
                    <div class="message-list" id="program-list">
                        <div class="loading">ƒêang t·∫£i ch∆∞∆°ng tr√¨nh...</div>
                    </div>
                </div>
            </div>

            <!-- üë• MEMBERS SECTION -->
            <div id="members-section" class="admin-section">
                <div class="messages-section">
                    <div class="section-header">
                        <span class="section-title">üë• Qu·∫£n l√Ω th√†nh vi√™n d·ª± √°n</span>
                        <button class="btn btn-success btn-small" onclick="showAddMemberForm()">+ Th√™m th√†nh
                            vi√™n</button>
                    </div>

                    <div id="member-form">
                        <h3 id="member-form-title">Th√™m th√†nh vi√™n m·ªõi</h3>
                        <div class="form-group"><label>H·ªç t√™n *</label><input type="text" id="member-name"
                                placeholder="Nguy·ªÖn VƒÉn A"></div>
                        <div class="form-group"><label>Vai tr√≤ *</label><input type="text" id="member-role"
                                placeholder="Tr∆∞·ªüng d·ª± √°n"></div>
                        <div class="form-group"><label>·∫¢nh ƒë·∫°i di·ªán (URL)</label><input type="text" id="member-avatar"
                                placeholder="https://..."></div>
                        <div class="form-group"><label>Gi·ªõi thi·ªáu ng·∫Øn</label><textarea id="member-bio" rows="3"
                                placeholder="M√¥ t·∫£ ng·∫Øn v·ªÅ th√†nh vi√™n"></textarea></div>
                        <div class="form-group"><label>Email (optional)</label><input type="email" id="member-email"
                                placeholder="email@domain.com"></div>
                        <div class="form-group"><label>Tr∆∞·ªùng (optional)</label><input type="text" id="member-school"
                                placeholder="T√™n tr∆∞·ªùng / khoa... "></div>
                        <div class="form-group"><label>Th√†nh t√≠ch</label><textarea id="member-achievements" rows="3"
                                placeholder="- 0.8/4 GPA ..."></textarea></div>
                        <div class="form-group"><label>C√¢u n√≥i y√™u th√≠ch (Quotes)</label><textarea id="member-quotes"
                                rows="3"
                                placeholder="V√≠ d·ª•: C·∫£m ∆°n b·∫°n ƒë√£ gh√© xem team t·ª•i m√¨nh. (M·ªói d√≤ng 1 c√¢u)"></textarea>
                        </div>
                        <div class="form-group"><label>Facebook (optional)</label><input type="text"
                                id="member-facebook" placeholder="https://facebook.com/..." /></div>
                        <div class="form-group"><label>Instagram (optional)</label><input type="text"
                                id="member-instagram" placeholder="https://instagram.com/..." /></div>
                        <div class="form-group"><label>Th·ªùi gian ho·∫°t ƒë·ªông (member)</label><input type="text"
                                id="member-activeTime" placeholder="V√≠ d·ª•: 2024 ‚Äì 2026"></div>
                        <div class="form-group">
                            <label>Tags (Role/Badge)</label>
                            <div id="member-tags-wrap" class="tag-picker">
                                <div class="loading" style="padding:0;">ƒêang t·∫£i tags...</div>
                            </div>
                            <div style="margin-top:8px; color:#999; font-size:12px;">T·∫°o / s·ª≠a tags ·ªü tab <b>üè∑Ô∏è
                                    Tags</b>.</div>
                        </div>

                        <div class="form-group"><label>Th·ª© t·ª± hi·ªÉn th·ªã</label><input type="number" id="member-order"
                                value="1" min="1"></div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="member-active" checked>
                            <label for="member-active">Hi·ªÉn th·ªã tr√™n trang th√†nh vi√™n</label>
                        </div>
                        <input type="hidden" id="member-id">
                        <button class="btn btn-primary" onclick="saveMember()">üíæ L∆∞u</button>
                        <button class="btn btn-warning" onclick="hideMemberForm()">‚ùå H·ªßy</button>
                    </div>

                    <div class="message-list" id="member-list">
                        <div class="loading">ƒêang t·∫£i th√†nh vi√™n...</div>
                    </div>
                </div>
            </div>

            <!-- üè∑Ô∏è TAGS SECTION -->
            <div id="tags-section" class="admin-section">
                <div class="messages-section">
                    <div class="section-header">
                        <span class="section-title">üè∑Ô∏è Qu·∫£n l√Ω Tags</span>
                        <button class="btn btn-success btn-small" onclick="showAddTagForm()">+ Th√™m tag</button>
                    </div>

                    <div id="tag-form">
                        <h3 id="tag-form-title">Th√™m tag m·ªõi</h3>
                        <div class="form-group"><label>M√£ tag (key) (ƒë·ªÉ tr·ªëng = auto)</label><input type="text"
                                id="tag-key" placeholder="vd: core-team (auto n·∫øu b·ªè tr·ªëng)"></div>
                        <div class="form-group"><label>Role/Text hi·ªÉn th·ªã *</label><input type="text" id="tag-role"
                                placeholder="vd: Core / Leader / Media"></div>
                        <div class="form-group">
                            <label>M√†u tag *</label>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <input type="color" id="tag-color" value="#7C3AED"
                                    style="width:54px; height:42px; border:none; background:transparent;">
                                <input type="text" id="tag-color-text" placeholder="#7C3AED" style="flex:1;">
                            </div>
                        </div>
                        <div class="form-group"><label>Th·ª© t·ª±</label><input type="number" id="tag-order" value="1"
                                min="1"></div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="tag-active" checked>
                            <label for="tag-active">ƒêang d√πng</label>
                        </div>
                        <input type="hidden" id="tag-id">
                        <button class="btn btn-primary" onclick="saveTag()">üíæ L∆∞u</button>
                        <button class="btn btn-warning" onclick="hideTagForm()">‚ùå H·ªßy</button>
                    </div>

                    <div class="message-list" id="tag-list">
                        <div class="loading">ƒêang t·∫£i tags...</div>
                    </div>
                </div>
            </div>
            <!-- üìä STATS BAR CONFIG SECTION -->
            <div id="stats-section" class="admin-section">
                <div class="messages-section">
                    <div class="section-header">
                        <span class="section-title">üìä C·∫•u h√¨nh Bar Th·ªëng k√™ (Trang ch·ªß)</span>
                    </div>

                    <div id="stats-form"
                        style="background:#f9f9f9; padding:20px; margin-bottom:20px; border-radius:8px;">
                        <h3 style="margin-bottom:10px;">Ch·ªânh s·ª≠a icon v√† nh√£n c·ªßa 4 th√¥ng s·ªë</h3>
                        <p style="margin-bottom:15px; color:#666; font-size:13px; line-height:1.5;">
                            S·ªë l∆∞·ª£ng s·∫Ω t·ª± ƒë·ªông ƒë·∫øm. B·∫°n c√≥ th·ªÉ s·ª≠a icon (emoji) v√† ch·ªØ hi·ªÉn th·ªã b√™n c·∫°nh con s·ªë.
                        </p>

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom: 20px;">
                            <!-- Stat 1: L·ªùi nh·∫Øn -->
                            <div style="background:#fff; padding:15px; border-radius:8px; border:1px solid #ddd;">
                                <h4 style="margin-bottom:10px; color:#e74c3c;">1. L·ªùi nh·∫Øn</h4>
                                <div class="form-group"><label>Icon (Emoji)</label><input type="text" id="stat-1-icon"
                                        placeholder="üíå"></div>
                                <div class="form-group"><label>Nh√£n hi·ªÉn th·ªã</label><input type="text" id="stat-1-label"
                                        placeholder="L·ªùi nh·∫Øn"></div>
                                <div class="form-group" style="margin-bottom:0;"><label>S·ªë hi·ªÉn th·ªã</label><input
                                        type="number" id="stat-1-count" placeholder="V√≠ d·ª•: 99"></div>
                            </div>

                            <!-- Stat 2: L∆∞·ª£t tim -->
                            <div style="background:#fff; padding:15px; border-radius:8px; border:1px solid #ddd;">
                                <h4 style="margin-bottom:10px; color:#e91e63;">2. L∆∞·ª£t th·∫£ tim</h4>
                                <div class="form-group"><label>Icon (Emoji)</label><input type="text" id="stat-2-icon"
                                        placeholder="‚ù§Ô∏è"></div>
                                <div class="form-group"><label>Nh√£n hi·ªÉn th·ªã</label><input type="text" id="stat-2-label"
                                        placeholder="L∆∞·ª£t th·∫£ tim"></div>
                                <div class="form-group" style="margin-bottom:0;"><label>S·ªë hi·ªÉn th·ªã</label><input
                                        type="number" id="stat-2-count" placeholder="V√≠ d·ª•: 9999"></div>
                            </div>

                            <!-- Stat 3: Gallery -->
                            <div style="background:#fff; padding:15px; border-radius:8px; border:1px solid #ddd;">
                                <h4 style="margin-bottom:10px; color:#4CAF50;">3. Gallery / Ho·∫°t ƒë·ªông</h4>
                                <div class="form-group"><label>Icon (Emoji)</label><input type="text" id="stat-3-icon"
                                        placeholder="üì∏"></div>
                                <div class="form-group"><label>Nh√£n hi·ªÉn th·ªã</label><input type="text" id="stat-3-label"
                                        placeholder="Ho·∫°t ƒë·ªông"></div>
                                <div class="form-group" style="margin-bottom:0;"><label>S·ªë hi·ªÉn th·ªã</label><input
                                        type="number" id="stat-3-count" placeholder="V√≠ d·ª•: 10"></div>
                            </div>

                            <!-- Stat 4: Members -->
                            <div style="background:#fff; padding:15px; border-radius:8px; border:1px solid #ddd;">
                                <h4 style="margin-bottom:10px; color:#2196F3;">4. Th√†nh vi√™n</h4>
                                <div class="form-group"><label>Icon (Emoji)</label><input type="text" id="stat-4-icon"
                                        placeholder="üë•"></div>
                                <div class="form-group"><label>Nh√£n hi·ªÉn th·ªã</label><input type="text" id="stat-4-label"
                                        placeholder="Th√†nh vi√™n"></div>
                                <div class="form-group" style="margin-bottom:0;"><label>S·ªë hi·ªÉn th·ªã</label><input
                                        type="number" id="stat-4-count" placeholder="V√≠ d·ª•: 50"></div>
                            </div>
                        </div>

                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <button class="btn btn-primary btn-small" onclick="saveStatsConfig()">üíæ L∆∞u c·∫•u h√¨nh
                                Bar</button>
                            <span style="font-size:12px; color:#999;">Field: settings/ui.statsConfig</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- üìñ JOURNEY SECTION -->
            <div id="journey-section" class="admin-section">
                <div class="messages-section">
                    <div class="section-header">
                        <span class="section-title">üìñ Qu·∫£n l√Ω H√†nh tr√¨nh (Origin)</span>
                        <button class="btn btn-success btn-small" onclick="showAddJourneyForm()">+ Th√™m Slide</button>
                    </div>

                    <div id="journey-form">
                        <h3 id="journey-form-title">Th√™m slide m·ªõi</h3>
                        <div class="form-group"><label>NƒÉm (ho·∫∑c Th·ªùi gian) *</label><input type="text"
                                id="journey-year" placeholder="VD: 2022"></div>
                        <div class="form-group"><label>T√™n ch∆∞∆°ng (Chapter)</label><input type="text"
                                id="journey-chapter" placeholder="VD: √ù T∆∞·ªüng Nhen Nh√≥m"></div>
                        <div class="form-group"><label>Ti√™u ƒë·ªÅ ch√≠nh (Title)</label><input type="text"
                                id="journey-title" placeholder="Ti√™u ƒë·ªÅ to"></div>
                        <div class="form-group"><label>Link ·∫£nh n·ªÅn *</label><input type="text" id="journey-image"
                                placeholder="https://example.com/banner.jpg"></div>
                        <div class="form-group"><label>N·ªôi dung chi ti·∫øt (HTML &lt;br&gt; &lt;strong&gt;
                                allow)</label><textarea id="journey-desc" rows="4"
                                placeholder="Vi·∫øt m√¥ t·∫£ ·ªü ƒë√¢y..."></textarea></div>
                        <div class="form-group"><label>Th·ª© t·ª± xu·∫•t hi·ªán</label><input type="number" id="journey-order"
                                value="1" min="1"></div>

                        <input type="hidden" id="journey-id">
                        <button class="btn btn-primary" onclick="saveJourney()">üíæ L∆∞u</button>
                        <button class="btn btn-warning" onclick="hideJourneyForm()">‚ùå H·ªßy</button>
                    </div>

                    <div class="message-list" id="journey-list">
                        <div class="loading">ƒêang t·∫£i slides...</div>
                    </div>
                </div>
            </div>

            <!-- ‚úâÔ∏è MESSAGES SECTION -->
            <div id="messages-section" class="admin-section">
                <!-- ‚è≥ PENDING MESSAGES -->
                <div class="messages-section">
                    <div class="section-header"><span class="section-title">‚è≥ L·ªùi nh·∫Øn ch·ªù duy·ªát</span><span
                            class="message-count" id="pending-count">0</span></div>
                    <div class="message-list" id="pending-list">
                        <div class="loading">ƒêang t·∫£i...</div>
                    </div>
                </div>

                <!-- ‚úÖ APPROVED MESSAGES -->
                <div class="messages-section">
                    <div class="section-header"><span class="section-title">‚úÖ L·ªùi nh·∫Øn ƒë√£ duy·ªát</span><span
                            class="message-count" id="approved-count">0</span></div>
                    <div class="message-list" id="approved-list">
                        <div class="loading">ƒêang t·∫£i...</div>
                    </div>
                </div>
            </div>

            <!-- üìß NEWSLETTER SECTION -->
            <div id="newsletter-section" class="admin-section">
                <div class="messages-section">
                    <div class="section-header">
                        <span class="section-title">üìß ƒêƒÉng k√Ω nh·∫≠n tin (Newsletter)</span>
                        <div style="display:flex; gap:10px;">
                            <span class="message-count" id="newsletter-count">0</span>
                            <button class="btn btn-success btn-small" onclick="exportNewsletterCSV()">üì• Xu·∫•t
                                CSV</button>
                        </div>
                    </div>

                    <div style="overflow-x:auto;">
                        <table
                            style="width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.05); margin-top:20px;">
                            <thead>
                                <tr style="background:#f1f5f9; text-align:left;">
                                    <th
                                        style="padding:12px 15px; border-bottom:1px solid #e2e8f0; font-size:14px; color:#475569;">
                                        Th·ªùi gian</th>
                                    <th
                                        style="padding:12px 15px; border-bottom:1px solid #e2e8f0; font-size:14px; color:#475569;">
                                        H·ªç T√™n</th>
                                    <th
                                        style="padding:12px 15px; border-bottom:1px solid #e2e8f0; font-size:14px; color:#475569;">
                                        Email</th>
                                    <th
                                        style="padding:12px 15px; border-bottom:1px solid #e2e8f0; font-size:14px; color:#475569;">
                                        Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="newsletter-list">
                                <tr>
                                    <td colspan="4" style="text-align:center; padding:20px;">ƒêang t·∫£i...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCKysT8eZ3LJqyi7vCjoqQGIpjgTyt7HYg",
            authDomain: "loiyeuthuong-5bfab.firebaseapp.com",
            projectId: "loiyeuthuong-5bfab",
            storageBucket: "loiyeuthuong-5bfab.firebasestorage.app",
            messagingSenderId: "544284022045",
            appId: "1:544284022045:web:22f2eef2ed918d93707df4"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let allMessages = [], filteredMessages = [];
        let editingGalleryId = null;
        let editingBannerId = null;
        let editingMemberId = null;
        let editingProgramId = null;
        let allTags = [];
        let editingTagId = null;
        let uiSettingsLoaded = false;


        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('dashboard-section').style.display = 'block';
                document.getElementById('admin-email-display').textContent = user.email;
                loadMessages();
                loadAdminGallery();
                loadAdminPrograms();
                loadBanners();
                loadMembers();
                loadTags();
                loadJourney();
                loadNewsletter();
            } else {
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('dashboard-section').style.display = 'none';
            }
        });

        // X·ª≠ l√Ω menu ƒëi·ªÅu h∆∞·ªõng
        document.addEventListener('DOMContentLoaded', function () {
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.addEventListener('click', function () {
                    // X√≥a active ·ªü t·∫•t c·∫£ menu item v√† section
                    menuItems.forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));

                    // Th√™m active v√†o item ƒë∆∞·ª£c click
                    this.classList.add('active');

                    // Hi·ªÉn th·ªã section t∆∞∆°ng ·ª©ng
                    const target = document.getElementById(this.getAttribute('data-target'));
                    if (target) {
                        target.classList.add('active');
                    }
                });
            });
        });

        async function handleLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            if (!email || !password) { showNotification('Vui l√≤ng nh·∫≠p email v√† m·∫≠t kh·∫©u!', 'error'); return; }
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showNotification('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
            } catch (e) { showNotification('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: ' + e.message, 'error'); }
        }

        async function handleLogout() {
            try { await auth.signOut(); showNotification('ƒê√£ ƒëƒÉng xu·∫•t!', 'success'); }
            catch (e) { showNotification('L·ªói: ' + e.message, 'error'); }
        }

        function loadMessages() {
            db.collection('messages').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                allMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), timestamp: doc.data().timestamp?.toDate() || new Date() }));
                filterMessages(); updateStats();
            }, error => { showNotification('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message, 'error'); });
        }

        function filterMessages() {
            const searchTerm = document.getElementById('search-box').value.toLowerCase();
            filteredMessages = allMessages.filter(msg => msg.text.toLowerCase().includes(searchTerm) || (msg.senderName && msg.senderName.toLowerCase().includes(searchTerm)));
            renderPendingMessages(); renderApprovedMessages();
        }

        function updateStats() {
            const total = allMessages.length;
            const pending = allMessages.filter(m => m.status === 'pending').length;
            const approved = allMessages.filter(m => m.status === 'approved').length;
            const totalLikes = allMessages.reduce((sum, m) => sum + (m.likes || 0), 0);
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-approved').textContent = approved;
            document.getElementById('stat-total-likes').textContent = totalLikes;
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('approved-count').textContent = approved;
        }

        async function updateLikeCount(messageId, newCount) {
            const count = parseInt(newCount);
            if (isNaN(count) || count < 0) { showNotification('S·ªë tim kh√¥ng h·ª£p l·ªá!', 'error'); return; }
            try {
                await db.collection('messages').doc(messageId).update({ likes: count });
                showNotification(`ƒê√£ c·∫≠p nh·∫≠t s·ªë tim th√†nh ${count}!`, 'success');
            } catch (e) { showNotification('L·ªói c·∫≠p nh·∫≠t: ' + e.message, 'error'); }
        }

        function renderPendingMessages() {
            const container = document.getElementById('pending-list');
            const pending = filteredMessages.filter(m => m.status === 'pending');
            if (pending.length === 0) { container.innerHTML = '<div class="empty">Kh√¥ng c√≥ l·ªùi nh·∫Øn ch·ªù duy·ªát</div>'; return; }
            container.innerHTML = pending.map(msg => `
                <div class="message-item">
                    <div class="sender-info"><span class="sender-name">‚úçÔ∏è ${escapeHtml(msg.senderName || 'Kh√¥ng r√µ')}</span>${msg.isAnonymous ? '<span class="anonymous-badge">üë§ ·∫®n danh</span>' : ''}</div>
                    <div class="message-text">${escapeHtml(msg.text)}</div>
                    <div class="message-meta"><span>üìÖ ${formatDate(msg.timestamp)}</span><span>‚ù§Ô∏è ${msg.likes || 0} l∆∞·ª£t tim</span></div>
                    <div class="message-actions">
                        <button class="btn btn-success btn-small" onclick="approveMessage('${msg.id}')">‚úÖ Duy·ªát</button>
                        <button class="btn btn-danger btn-small" onclick="rejectMessage('${msg.id}')">‚ùå T·ª´ ch·ªëi</button>
                        <div class="edit-like-container"><span class="current-likes">‚ù§Ô∏è ${msg.likes || 0}</span><input type="number" class="edit-like-input" id="edit-like-${msg.id}" placeholder="S·ªë tim m·ªõi" min="0"><button class="btn btn-info btn-small" onclick="updateLikeCount('${msg.id}', document.getElementById('edit-like-${msg.id}').value)">üíæ C·∫≠p nh·∫≠t</button></div>
                    </div>
                </div>`).join('');
        }

        function renderApprovedMessages() {
            const container = document.getElementById('approved-list');
            const approved = filteredMessages.filter(m => m.status === 'approved');
            if (approved.length === 0) { container.innerHTML = '<div class="empty">Kh√¥ng c√≥ l·ªùi nh·∫Øn ƒë√£ duy·ªát</div>'; return; }
            container.innerHTML = approved.map(msg => `
                <div class="message-item approved">
                    <div class="sender-info"><span class="sender-name">‚úçÔ∏è ${escapeHtml(msg.senderName || 'Kh√¥ng r√µ')}</span>${msg.isAnonymous ? '<span class="anonymous-badge">üë§ ·∫®n danh</span>' : ''}</div>
                    <div class="message-text">${escapeHtml(msg.text)}</div>
                    <div class="message-meta"><span>üìÖ ${formatDate(msg.timestamp)}</span><span>‚ù§Ô∏è ${msg.likes || 0} l∆∞·ª£t tim</span></div>
                    <div class="message-actions">
                        <button class="btn btn-warning btn-small" onclick="unapproveMessage('${msg.id}')">‚Ü©Ô∏è H·ªßy duy·ªát</button>
                        <button class="btn btn-danger btn-small" onclick="deleteMessage('${msg.id}')">üóëÔ∏è X√≥a</button>
                        <div class="edit-like-container"><span class="current-likes">‚ù§Ô∏è ${msg.likes || 0}</span><input type="number" class="edit-like-input" id="edit-like-approved-${msg.id}" placeholder="S·ªë tim m·ªõi" min="0"><button class="btn btn-info btn-small" onclick="updateLikeCount('${msg.id}', document.getElementById('edit-like-approved-${msg.id}').value)">üíæ C·∫≠p nh·∫≠t</button></div>
                    </div>
                </div>`).join('');
        }

        async function approveMessage(id) { try { await db.collection('messages').doc(id).update({ status: 'approved' }); showNotification('ƒê√£ duy·ªát l·ªùi nh·∫Øn!', 'success'); } catch (e) { showNotification('L·ªói: ' + e.message, 'error'); } }
        async function rejectMessage(id) { try { await db.collection('messages').doc(id).update({ status: 'rejected' }); showNotification('ƒê√£ t·ª´ ch·ªëi l·ªùi nh·∫Øn!', 'success'); } catch (e) { showNotification('L·ªói: ' + e.message, 'error'); } }
        async function unapproveMessage(id) { try { await db.collection('messages').doc(id).update({ status: 'pending' }); showNotification('ƒê√£ h·ªßy duy·ªát l·ªùi nh·∫Øn!', 'success'); } catch (e) { showNotification('L·ªói: ' + e.message, 'error'); } }
        async function deleteMessage(id) { if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªùi nh·∫Øn n√†y kh√¥ng?')) return; try { await db.collection('messages').doc(id).delete(); showNotification('ƒê√£ x√≥a l·ªùi nh·∫Øn!', 'success'); } catch (e) { showNotification('L·ªói: ' + e.message, 'error'); } }

        // üî• GALLERY FUNCTIONS
        function showAddGalleryForm() {
            document.getElementById('gallery-form').style.display = 'block';
            document.getElementById('gallery-form-title').textContent = 'Th√™m ·∫£nh / Ho·∫°t ƒë·ªông m·ªõi';
            document.getElementById('gallery-image').value = '';
            document.getElementById('gallery-title').value = '';
            document.getElementById('gallery-description').value = '';
            document.getElementById('gallery-content').value = '';
            document.getElementById('gallery-extra-images').value = '';
            document.getElementById('gallery-order').value = '1';
            document.getElementById('gallery-id').value = '';
            editingGalleryId = null;
        }
        function hideGalleryForm() { document.getElementById('gallery-form').style.display = 'none'; }

        async function saveGallery() {
            const image = document.getElementById('gallery-image').value.trim();
            const title = document.getElementById('gallery-title').value.trim();
            const description = document.getElementById('gallery-description').value.trim();
            const content = document.getElementById('gallery-content').value.trim();
            const extraImagesRaw = document.getElementById('gallery-extra-images').value.trim();
            const extraImages = extraImagesRaw ? extraImagesRaw.split('\n').map(x => x.trim()).filter(Boolean) : [];
            const order = parseInt(document.getElementById('gallery-order').value) || 1;
            if (!image || !title) { showNotification('Vui l√≤ng nh·∫≠p √≠t nh·∫•t link ·∫£nh v√† ti√™u ƒë·ªÅ!', 'error'); return; }
            const galleryData = { image, title, description, content, extraImages, order, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
            try {
                if (editingGalleryId) {
                    await db.collection('gallery').doc(editingGalleryId).update(galleryData);
                    showNotification('ƒê√£ c·∫≠p nh·∫≠t ·∫£nh!', 'success');
                } else {
                    galleryData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('gallery').add(galleryData);
                    showNotification('ƒê√£ th√™m ·∫£nh m·ªõi!', 'success');
                }
                hideGalleryForm(); loadAdminGallery();
            } catch (e) { showNotification('L·ªói: ' + e.message, 'error'); }
        }

        async function editGallery(id) {
            const doc = await db.collection('gallery').doc(id).get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('gallery-form').style.display = 'block';
                document.getElementById('gallery-form-title').textContent = 'Ch·ªânh s·ª≠a ho·∫°t ƒë·ªông';
                document.getElementById('gallery-image').value = data.image || '';
                document.getElementById('gallery-title').value = data.title || '';
                document.getElementById('gallery-description').value = data.description || '';
                document.getElementById('gallery-content').value = data.content || '';
                document.getElementById('gallery-extra-images').value = (data.extraImages || []).join('\n');
                document.getElementById('gallery-order').value = data.order || 1;
                document.getElementById('gallery-id').value = id;
                editingGalleryId = id;
            }
        }

        async function deleteGallery(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y?')) return;
            try { await db.collection('gallery').doc(id).delete(); showNotification('ƒê√£ x√≥a ·∫£nh!', 'success'); loadAdminGallery(); }
            catch (e) { showNotification('L·ªói: ' + e.message, 'error'); }
        }

        function loadAdminGallery() {
            db.collection('gallery').orderBy('order', 'asc').onSnapshot(snapshot => {
                const container = document.getElementById('gallery-list');
                if (snapshot.empty) { container.innerHTML = '<div class="empty">Ch∆∞a c√≥ ·∫£nh n√†o trong gallery</div>'; return; }
                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return `<div class="gallery-item"><img src="${data.image}" alt="${data.title}"><div class="info"><h4>${data.title}</h4><p>${data.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p><p class="order">Th·ª© t·ª±: ${data.order}</p></div><div style="display:flex; gap:10px;"><button class="btn btn-warning btn-small" onclick="editGallery('${doc.id}')">‚úèÔ∏è S·ª≠a</button><button class="btn btn-danger btn-small" onclick="deleteGallery('${doc.id}')">üóëÔ∏è X√≥a</button></div></div>`;
                }).join('');
            });
        }

        // üî• PROGRAMS FUNCTIONS
        function showAddProgramForm() {
            document.getElementById('program-form').style.display = 'block';
            document.getElementById('program-form-title').textContent = 'Th√™m ch∆∞∆°ng tr√¨nh m·ªõi';
            document.getElementById('program-image').value = '';
            document.getElementById('program-title').value = '';
            document.getElementById('program-description').value = '';
            document.getElementById('program-content').value = '';
            document.getElementById('program-order').value = '1';
            document.getElementById('program-id').value = '';
            editingProgramId = null;
        }
        function hideProgramForm() { document.getElementById('program-form').style.display = 'none'; }

        async function saveProgram() {
            const image = document.getElementById('program-image').value.trim();
            const title = document.getElementById('program-title').value.trim();
            const description = document.getElementById('program-description').value.trim();
            const content = document.getElementById('program-content').value.trim();
            const order = parseInt(document.getElementById('program-order').value) || 1;
            if (!image || !title) { showNotification('Vui l√≤ng nh·∫≠p link ·∫£nh v√† ti√™u ƒë·ªÅ!', 'error'); return; }

            const programData = { image, title, description, content, order, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
            try {
                if (editingProgramId) {
                    await db.collection('programs').doc(editingProgramId).update(programData);
                    showNotification('ƒê√£ c·∫≠p nh·∫≠t ch∆∞∆°ng tr√¨nh!', 'success');
                } else {
                    programData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('programs').add(programData);
                    showNotification('ƒê√£ th√™m ch∆∞∆°ng tr√¨nh m·ªõi!', 'success');
                }
                hideProgramForm();
            } catch (e) { showNotification('L·ªói: ' + e.message, 'error'); }
        }

        async function editProgram(id) {
            const doc = await db.collection('programs').doc(id).get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('program-form').style.display = 'block';
                document.getElementById('program-form-title').textContent = 'Ch·ªânh s·ª≠a ch∆∞∆°ng tr√¨nh';
                document.getElementById('program-image').value = data.image || '';
                document.getElementById('program-title').value = data.title || '';
                document.getElementById('program-description').value = data.description || '';
                document.getElementById('program-content').value = data.content || '';
                document.getElementById('program-order').value = data.order || 1;
                document.getElementById('program-id').value = id;
                editingProgramId = id;
            }
        }

        async function deleteProgram(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ch∆∞∆°ng tr√¨nh n√†y?')) return;
            try { await db.collection('programs').doc(id).delete(); showNotification('ƒê√£ x√≥a ch∆∞∆°ng tr√¨nh!', 'success'); }
            catch (e) { showNotification('L·ªói: ' + e.message, 'error'); }
        }

        function loadAdminPrograms() {
            db.collection('programs').orderBy('order', 'asc').onSnapshot(snapshot => {
                const container = document.getElementById('program-list');
                if (snapshot.empty) { container.innerHTML = '<div class="empty">Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh n√†o</div>'; return; }
                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return `<div class="gallery-item"><img src="${data.image}" alt="${data.title}"><div class="info"><h4>${data.title}</h4><p>${data.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p><p class="order">Th·ª© t·ª±: ${data.order}</p></div><div style="display:flex; gap:10px;"><button class="btn btn-warning btn-small" onclick="editProgram('${doc.id}')">‚úèÔ∏è S·ª≠a</button><button class="btn btn-danger btn-small" onclick="deleteProgram('${doc.id}')">üóëÔ∏è X√≥a</button></div></div>`;
                }).join('');
            });
        }

        // üî•üî•üî• BANNER FUNCTIONS (NEW) üî•üî•üî•
        function showAddBannerForm() {
            document.getElementById('banner-form').style.display = 'block';
            document.getElementById('banner-form-title').textContent = 'Th√™m banner m·ªõi';
            document.getElementById('banner-image').value = '';
            document.getElementById('banner-title').value = '';
            document.getElementById('banner-link').value = '';
            document.getElementById('banner-order').value = '1';
            document.getElementById('banner-active').checked = true;
            document.getElementById('banner-id').value = '';
            editingBannerId = null;
        }
        function hideBannerForm() { document.getElementById('banner-form').style.display = 'none'; }

        async function saveBanner() {
            const image = document.getElementById('banner-image').value.trim();
            const title = document.getElementById('banner-title').value.trim();
            const link = document.getElementById('banner-link').value.trim();
            const order = parseInt(document.getElementById('banner-order').value) || 1;
            const active = document.getElementById('banner-active').checked;

            if (!image) { showNotification('Vui l√≤ng nh·∫≠p link ·∫£nh banner!', 'error'); return; }

            const bannerData = { image, title, link, order, active, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };

            try {
                if (editingBannerId) {
                    await db.collection('banners').doc(editingBannerId).update(bannerData);
                    showNotification('ƒê√£ c·∫≠p nh·∫≠t banner!', 'success');
                } else {
                    bannerData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('banners').add(bannerData);
                    showNotification('ƒê√£ th√™m banner m·ªõi!', 'success');
                }
                hideBannerForm(); loadBanners();
            } catch (e) { showNotification('L·ªói: ' + e.message, 'error'); }
        }

        async function editBanner(id) {
            const doc = await db.collection('banners').doc(id).get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('banner-form').style.display = 'block';
                document.getElementById('banner-form-title').textContent = 'Ch·ªânh s·ª≠a banner';
                document.getElementById('banner-image').value = data.image || '';
                document.getElementById('banner-title').value = data.title || '';
                document.getElementById('banner-link').value = data.link || '';
                document.getElementById('banner-order').value = data.order || 1;
                document.getElementById('banner-active').checked = data.active !== false;
                document.getElementById('banner-id').value = id;
                editingBannerId = id;
            }
        }

        async function deleteBanner(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a banner n√†y?')) return;
            try { await db.collection('banners').doc(id).delete(); showNotification('ƒê√£ x√≥a banner!', 'success'); loadBanners(); }
            catch (e) { showNotification('L·ªói: ' + e.message, 'error'); }
        }

        function loadBanners() {
            db.collection('banners').orderBy('order', 'asc').onSnapshot(snapshot => {
                const container = document.getElementById('banner-list');
                if (snapshot.empty) { container.innerHTML = '<div class="empty">Ch∆∞a c√≥ banner n√†o</div>'; return; }
                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const statusBadge = data.active ? '<span class="status-badge status-active">‚óè Hi·ªÉn th·ªã</span>' : '<span class="status-badge status-inactive">‚óè ·∫®n</span>';
                    return `
                        <div class="banner-item">
                            <img src="${data.image}" alt="${data.title || 'Banner'}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%2280%22><rect fill=%22%23eee%22 width=%22100%%22 height=%22100%%22/><text x=%2250%%22 y=%2250%%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22>Kh√¥ng t·∫£i ƒë∆∞·ª£c ·∫£nh</text></svg>'">
                            <div class="info">
                                <h4>${data.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ'} ${statusBadge}</h4>
                                <p><strong>Th·ª© t·ª±:</strong> ${data.order}</p>
                                ${data.link ? `<p><strong>Link:</strong> <a href="${data.link}" target="_blank" style="color:#2196F3;">${data.link.substring(0, 40)}${data.link.length > 40 ? '...' : ''}</a></p>` : ''}
                            </div>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <button class="btn btn-warning btn-small" onclick="editBanner('${doc.id}')">‚úèÔ∏è S·ª≠a</button>
                                <button class="btn btn-danger btn-small" onclick="deleteBanner('${doc.id}')">üóëÔ∏è X√≥a</button>
                            </div>
                        </div>`;
                }).join('');
            });
        }

        // ===== TAGS (Role/Badge) =====
        function slugify(str) {
            try {
                return (str || '')
                    .toString()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .toLowerCase()
                    .trim()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-');
            } catch (e) {
                return (str || '').toString().toLowerCase().trim().replace(/\s+/g, '-');
            }
        }

        function normalizeHexColor(value) {
            const v = (value || '').toString().trim();
            if (!v) return '';
            const m = v.match(/^#?[0-9a-fA-F]{6}$/);
            if (!m) return '';
            return (v.startsWith('#') ? v : ('#' + v)).toUpperCase();
        }

        function syncColorInputs() {
            const c = document.getElementById('tag-color');
            const t = document.getElementById('tag-color-text');
            if (!c || !t) return;
            t.value = (c.value || '').toUpperCase();
        }

        function showAddTagForm() {
            document.getElementById('tag-form').style.display = 'block';
            document.getElementById('tag-form-title').textContent = 'Th√™m tag m·ªõi';
            document.getElementById('tag-id').value = '';
            document.getElementById('tag-key').value = '';
            document.getElementById('tag-key').removeAttribute('readonly');
            document.getElementById('tag-role').value = '';
            document.getElementById('tag-order').value = '1';
            document.getElementById('tag-active').checked = true;
            document.getElementById('tag-color').value = '#7C3AED';
            syncColorInputs();
            editingTagId = null;
        }
        function hideTagForm() { document.getElementById('tag-form').style.display = 'none'; }

        async function saveTag() {
            const keyEl = document.getElementById('tag-key');
            const role = (document.getElementById('tag-role').value || '').trim();
            const order = parseInt(document.getElementById('tag-order').value, 10) || 1;
            const active = document.getElementById('tag-active').checked;
            const color = normalizeHexColor(document.getElementById('tag-color-text').value) || normalizeHexColor(document.getElementById('tag-color').value) || '#7C3AED';

            if (!role) { showNotification('Vui l√≤ng nh·∫≠p Role/Text hi·ªÉn th·ªã!', 'error'); return; }

            let key = (keyEl.value || '').trim();
            if (!key) key = slugify(role);
            if (!key) { showNotification('Kh√¥ng t·∫°o ƒë∆∞·ª£c m√£ tag (key).', 'error'); return; }

            const tagData = { role, color, order, active, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };

            try {
                if (editingTagId) {
                    await db.collection('tags').doc(editingTagId).update(tagData);
                    showNotification('ƒê√£ c·∫≠p nh·∫≠t tag!', 'success');
                } else {
                    tagData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('tags').doc(key).set(tagData);
                    showNotification('ƒê√£ th√™m tag m·ªõi!', 'success');
                }
                hideTagForm();
            } catch (e) {
                showNotification('L·ªói: ' + e.message, 'error');
            }
        }

        async function editTag(id) {
            const doc = await db.collection('tags').doc(id).get();
            if (!doc.exists) return;
            const data = doc.data() || {};
            document.getElementById('tag-form').style.display = 'block';
            document.getElementById('tag-form-title').textContent = 'Ch·ªânh s·ª≠a tag';
            document.getElementById('tag-id').value = id;
            document.getElementById('tag-key').value = id;
            document.getElementById('tag-key').setAttribute('readonly', 'readonly');
            document.getElementById('tag-role').value = data.role || '';
            document.getElementById('tag-order').value = data.order || 1;
            document.getElementById('tag-active').checked = data.active !== false;
            document.getElementById('tag-color').value = normalizeHexColor(data.color) || '#7C3AED';
            syncColorInputs();
            editingTagId = id;
        }

        async function deleteTag(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a tag n√†y?')) return;
            try {
                await db.collection('tags').doc(id).delete();
                showNotification('ƒê√£ x√≥a tag!', 'success');
            } catch (e) {
                showNotification('L·ªói: ' + e.message, 'error');
            }
        }

        function renderTagList() {
            const container = document.getElementById('tag-list');
            if (!container) return;
            if (!allTags.length) {
                container.innerHTML = '<div class="empty">Ch∆∞a c√≥ tag n√†o</div>';
                return;
            }
            container.innerHTML = allTags.map(t => {
                const sw = `<span class="tag-swatch" style="background:${t.color || '#7C3AED'}"></span>`;
                const pill = `<span class="tag-pill">${sw}<span>${t.role || t.id}</span></span>`;
                const status = (t.active !== false) ? '<span class="status-badge status-active">‚óè ƒêang d√πng</span>' : '<span class="status-badge status-inactive">‚óè T·∫Øt</span>';
                return `
                    <div class="tag-item">
                        <div style="flex:1;">
                            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">${pill} ${status}</div>
                            <div style="margin-top:8px; color:#666; font-size:13px;">
                                <b>Key:</b> <code>${t.id}</code> ‚Ä¢ <b>Order:</b> ${t.order || 1} ‚Ä¢ <b>Color:</b> ${(t.color || ''.toString())}
                            </div>
                        </div>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <button class="btn btn-warning btn-small" onclick="editTag('${t.id}')">‚úèÔ∏è S·ª≠a</button>
                            <button class="btn btn-danger btn-small" onclick="deleteTag('${t.id}')">üóëÔ∏è X√≥a</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderMemberTagOptions(selected) {
            const wrap = document.getElementById('member-tags-wrap');
            if (!wrap) return;
            const sel = new Set(Array.isArray(selected) ? selected : []);

            if (!allTags || !allTags.length) {
                wrap.innerHTML = '<div class="empty" style="padding:0;">Ch∆∞a c√≥ tag n√†o (t·∫°o ·ªü tab Tags)</div>';
                return;
            }

            const list = [...allTags].sort((a, b) => {
                const aa = (a.active !== false) ? 1 : 0;
                const bb = (b.active !== false) ? 1 : 0;
                if (bb != aa) return bb - aa;
                return (a.order || 9999) - (b.order || 9999);
            });

            wrap.innerHTML = list.map(t => {
                const checked = sel.has(t.id) ? 'checked' : '';
                const color = t.color || '#7C3AED';
                const label = t.role || t.id;
                return `
                    <label class="tag-check" title="${t.id}">
                        <input type="checkbox" value="${t.id}" ${checked}>
                        <span class="tag-swatch" style="background:${color}"></span>
                        <span class="tag-text">${label}</span>
                    </label>
                `;
            }).join('');
        }

        function getSelectedMemberTags() {
            const wrap = document.getElementById('member-tags-wrap');
            if (!wrap) return [];
            return Array.from(wrap.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        }

        function loadTags() {
            db.collection('tags').orderBy('order', 'asc').onSnapshot(snapshot => {
                allTags = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTagList();
                renderMemberTagOptions(getSelectedMemberTags());
            }, error => {
                const container = document.getElementById('tag-list');
                if (container) container.innerHTML = '<div class="empty">L·ªói t·∫£i tags: ' + error.message || '' + '</div>';
            });

            const c = document.getElementById('tag-color');
            const t = document.getElementById('tag-color-text');
            if (c && t) {
                c.addEventListener('input', syncColorInputs);
                t.addEventListener('input', () => {
                    const v = normalizeHexColor(t.value);
                    if (v) c.value = v;
                });
                syncColorInputs();
            }
        }

        function showAddMemberForm() {
            document.getElementById('member-form').style.display = 'block';
            document.getElementById('member-form-title').textContent = 'Th√™m th√†nh vi√™n m·ªõi';
            document.getElementById('member-name').value = '';
            document.getElementById('member-role').value = '';
            document.getElementById('member-avatar').value = '';
            document.getElementById('member-bio').value = '';
            const em = document.getElementById('member-email'); if (em) em.value = '';
            const sch = document.getElementById('member-school'); if (sch) sch.value = '';
            const ach = document.getElementById('member-achievements'); if (ach) ach.value = '';
            const mq = document.getElementById('member-quotes'); if (mq) mq.value = '';
            document.getElementById('member-facebook').value = '';
            document.getElementById('member-instagram').value = '';
            const at = document.getElementById('member-activeTime'); if (at) at.value = '';
            renderMemberTagOptions([]);
            document.getElementById('member-order').value = '1';
            document.getElementById('member-active').checked = true;
            document.getElementById('member-id').value = '';
            editingMemberId = null;
        }

        function hideMemberForm() {
            document.getElementById('member-form').style.display = 'none';
        }

        async function saveMember() {
            const name = document.getElementById('member-name').value.trim();
            const role = document.getElementById('member-role').value.trim();
            const avatar = document.getElementById('member-avatar').value.trim();
            const bio = document.getElementById('member-bio').value.trim();
            const email = (document.getElementById('member-email')?.value || '').trim();
            const school = (document.getElementById('member-school')?.value || '').trim();
            const achievements = (document.getElementById('member-achievements')?.value || '').trim();
            const quotes = (document.getElementById('member-quotes')?.value || '').trim();
            const facebook = document.getElementById('member-facebook').value.trim();
            const instagram = document.getElementById('member-instagram').value.trim();
            const activeTime = (document.getElementById('member-activeTime')?.value || '').trim();
            const tags = getSelectedMemberTags();
            const order = parseInt(document.getElementById('member-order').value) || 1;
            const active = document.getElementById('member-active').checked;

            if (!name || !role) {
                showNotification('Vui l√≤ng nh·∫≠p t√™n v√† vai tr√≤ th√†nh vi√™n!', 'error');
                return;
            }

            const memberData = { name, role, avatar, bio, email, school, achievements, quotes, facebook, instagram, order, active, tags, activeTime, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };

            try {
                if (editingMemberId) {
                    await db.collection('members').doc(editingMemberId).update(memberData);
                    showNotification('ƒê√£ c·∫≠p nh·∫≠t th√†nh vi√™n!', 'success');
                } else {
                    memberData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('members').add(memberData);
                    showNotification('ƒê√£ th√™m th√†nh vi√™n m·ªõi!', 'success');
                }
                hideMemberForm();
                loadMembers();
            } catch (e) {
                showNotification('L·ªói: ' + e.message, 'error');
            }
        }

        async function editMember(id) {
            const doc = await db.collection('members').doc(id).get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('member-form').style.display = 'block';
                document.getElementById('member-form-title').textContent = 'Ch·ªânh s·ª≠a th√†nh vi√™n';
                document.getElementById('member-name').value = data.name || '';
                document.getElementById('member-role').value = data.role || '';
                document.getElementById('member-avatar').value = data.avatar || '';
                document.getElementById('member-bio').value = data.bio || '';
                const em = document.getElementById('member-email'); if (em) em.value = data.email || '';
                const sch = document.getElementById('member-school'); if (sch) sch.value = data.school || '';
                const ach = document.getElementById('member-achievements'); if (ach) ach.value = data.achievements || '';
                const mq = document.getElementById('member-quotes'); if (mq) mq.value = data.quotes || '';
                document.getElementById('member-facebook').value = data.facebook || '';
                document.getElementById('member-instagram').value = data.instagram || '';
                const at = document.getElementById('member-activeTime'); if (at) at.value = data.activeTime || '';
                renderMemberTagOptions(Array.isArray(data.tags) ? data.tags : []);
                document.getElementById('member-order').value = data.order || 1;
                document.getElementById('member-active').checked = data.active !== false;
                document.getElementById('member-id').value = id;
                editingMemberId = id;
            }
        }

        async function deleteMember(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th√†nh vi√™n n√†y?')) return;
            try {
                await db.collection('members').doc(id).delete();
                showNotification('ƒê√£ x√≥a th√†nh vi√™n!', 'success');
                loadMembers();
            } catch (e) {
                showNotification('L·ªói: ' + e.message, 'error');
            }
        }

        function loadMembers() {
            db.collection('members').orderBy('order', 'asc').onSnapshot(snapshot => {
                const container = document.getElementById('member-list');
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty">Ch∆∞a c√≥ th√†nh vi√™n n√†o</div>';
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const statusBadge = data.active ? '<span class="status-badge status-active">‚óè Hi·ªÉn th·ªã</span>' : '<span class="status-badge status-inactive">‚óè ·∫®n</span>';
                    return `
                        <div class="member-item">
                            <img src="${data.avatar || 'https://ui-avatars.com/api/?background=e74c3c&color=fff&name=' + encodeURIComponent(data.name || 'Member')}" alt="${data.name || 'Member'}">
                            <div class="info">
                                <h4>${data.name || 'Ch∆∞a c√≥ t√™n'} ${statusBadge}</h4>
                                <p><strong>Vai tr√≤:</strong> ${data.role || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
                                ${data.bio ? `<p>${data.bio}</p>` : ''}
                                <p><strong>Th·ª© t·ª±:</strong> ${data.order || 1}</p>
                                ${(data.facebook || data.instagram) ? `<p>${data.facebook ? `<a href="${data.facebook}" target="_blank" style="color:#1877f2; margin-right: 10px;">Facebook</a>` : ''}${data.instagram ? `<a href="${data.instagram}" target="_blank" style="color:#e1306c;">Instagram</a>` : ''}</p>` : ''}
                            </div>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <button class="btn btn-warning btn-small" onclick="editMember('${doc.id}')">‚úèÔ∏è S·ª≠a</button>
                                <button class="btn btn-danger btn-small" onclick="deleteMember('${doc.id}')">üóëÔ∏è X√≥a</button>
                            </div>
                        </div>`;
                }).join('');
            });
        }

        // ===== JOURNEY (ORIGIN) =====
        let editingJourneyId = null;

        function showAddJourneyForm() {
            document.getElementById('journey-form').style.display = 'block';
            document.getElementById('journey-form-title').textContent = 'Th√™m slide h√†nh tr√¨nh m·ªõi';
            document.getElementById('journey-year').value = '';
            document.getElementById('journey-chapter').value = '';
            document.getElementById('journey-title').value = '';
            document.getElementById('journey-image').value = '';
            document.getElementById('journey-desc').value = '';
            document.getElementById('journey-order').value = '';
            document.getElementById('journey-id').value = '';
            editingJourneyId = null;
        }

        function hideJourneyForm() {
            document.getElementById('journey-form').style.display = 'none';
        }

        async function saveJourney() {
            const year = document.getElementById('journey-year').value.trim();
            const chapter = document.getElementById('journey-chapter').value.trim();
            const title = document.getElementById('journey-title').value.trim();
            const image = document.getElementById('journey-image').value.trim();
            const desc = document.getElementById('journey-desc').value.trim();
            const order = parseInt(document.getElementById('journey-order').value) || 1;

            if (!year || !image) {
                showNotification('Vui l√≤ng nh·∫≠p nƒÉm v√† link ·∫£nh!', 'error');
                return;
            }

            try {
                if (editingJourneyId) {
                    await db.collection('journey').doc(editingJourneyId).update({ year, chapter, title, image, desc, order });
                    showNotification('ƒê√£ c·∫≠p nh·∫≠t slide!', 'success');
                } else {
                    await db.collection('journey').add({ year, chapter, title, image, desc, order });
                    showNotification('ƒê√£ th√™m slide m·ªõi!', 'success');
                }
                hideJourneyForm();
            } catch (e) {
                showNotification('L·ªói: ' + e.message, 'error');
            }
        }

        async function editJourney(id) {
            const doc = await db.collection('journey').doc(id).get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('journey-form').style.display = 'block';
                document.getElementById('journey-form-title').textContent = 'S·ª≠a slide h√†nh tr√¨nh';
                document.getElementById('journey-year').value = data.year || '';
                document.getElementById('journey-chapter').value = data.chapter || '';
                document.getElementById('journey-title').value = data.title || '';
                document.getElementById('journey-image').value = data.image || '';
                document.getElementById('journey-desc').value = data.desc || '';
                document.getElementById('journey-order').value = data.order || 1;
                document.getElementById('journey-id').value = id;
                editingJourneyId = id;
            }
        }

        async function deleteJourney(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a slide n√†y?')) return;
            try {
                await db.collection('journey').doc(id).delete();
                showNotification('ƒê√£ x√≥a slide!', 'success');
            } catch (e) {
                showNotification('L·ªói: ' + e.message, 'error');
            }
        }

        function loadJourney() {
            db.collection('journey').orderBy('order', 'asc').onSnapshot(snapshot => {
                const container = document.getElementById('journey-list');
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty">Ch∆∞a c√≥ slide n√†o</div>';
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return `
                        <div class="gallery-item">
                            <img src="${data.image}" alt="Slide">
                            <div class="info">
                                <h4>M·ªëc: ${data.year} - ${data.title}</h4>
                                <p>${data.chapter}</p>
                                <p class="order">Th·ª© t·ª±: ${data.order || 1}</p>
                            </div>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <button class="btn btn-warning btn-small" onclick="editJourney('${doc.id}')">‚úèÔ∏è S·ª≠a</button>
                                <button class="btn btn-danger btn-small" onclick="deleteJourney('${doc.id}')">üóëÔ∏è X√≥a</button>
                            </div>
                        </div>`;
                }).join('');
            });
        }

        // ===== NEWSLETTER =====
        let allNewsletters = [];

        function loadNewsletter() {
            db.collection('newsletter').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                const container = document.getElementById('newsletter-list');
                const countBadge = document.getElementById('newsletter-count');

                allNewsletters = [];
                countBadge.textContent = snapshot.docs.length;

                if (snapshot.empty) {
                    container.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#666;">Ch∆∞a c√≥ l∆∞·ª£t ƒëƒÉng k√Ω n√†o</td></tr>';
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const timeStr = data.timestamp ? formatDate(data.timestamp.toDate()) : 'Kh√¥ng r√µ';
                    const name = data.name || 'N/A';
                    const email = data.email || 'N/A';

                    allNewsletters.push({
                        time: timeStr,
                        name: name,
                        email: email
                    });

                    return `<tr style="border-bottom:1px solid #e2e8f0;">
                        <td style="padding:12px 15px; font-size:13px; color:#64748b;">${timeStr}</td>
                        <td style="padding:12px 15px; font-size:14px; font-weight:500;">${name}</td>
                        <td style="padding:12px 15px; font-size:14px; color:#1e293b;"><a href="mailto:${email}" target="_blank" style="color:#7c3aed; text-decoration:none;">${email}</a></td>
                        <td style="padding:12px 15px;">
                            <button class="btn btn-danger btn-small" onclick="deleteNewsletter('${doc.id}')" style="padding: 4px 8px; font-size: 11px;">üóëÔ∏è X√≥a</button>
                        </td>
                    </tr>`;
                }).join('');
            });
        }

        async function deleteNewsletter(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a email ƒëƒÉng k√Ω n√†y?')) return;
            try {
                await db.collection('newsletter').doc(id).delete();
                showNotification('ƒê√£ x√≥a d·ªØ li·ªáu', 'success');
            } catch (e) {
                showNotification('L·ªói: ' + e.message, 'error');
            }
        }

        function exportNewsletterCSV() {
            if (allNewsletters.length === 0) {
                showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i v·ªÅ', 'warning');
                return;
            }

            // CSV BOM for UTF-8 Excel support
            let csvContent = "t_EF_BB_BF";
            csvContent += "Th·ªùi gian,H·ªç T√™n,Email\n";

            allNewsletters.forEach(item => {
                // Escape quotes
                let row = [
                    `"${item.time}"`,
                    `"${item.name.replace(/"/g, '""')}"`,
                    `"${item.email.replace(/"/g, '""')}"`
                ].join(',');
                csvContent += row + "\n";
            });

            // Convert t_EF_BB_BF prefix back to byte sequence
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent.slice(10)], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `newsletter_export_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }


        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function formatDate(date) { if (!date) return 'N/A'; return date.toLocaleString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }
        document.addEventListener('keypress', e => { if (e.key === 'Enter' && e.target.tagName === 'INPUT') handleLogin(); });
    </script>
</body>

</html>